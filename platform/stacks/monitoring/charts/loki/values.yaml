---
loki:
  global:
    # This cluster does not use the default `cluster.local` DNS suffix.
    # Without this, Loki (and the gateway) will try to resolve `*.svc.cluster.local`
    # and fail (e.g. memcached SRV lookups, gateway resolver).
    clusterDomain: prod-ap-south-2a.local

  deploymentMode: SingleBinary

  loki:
    auth_enabled: false
    commonConfig:
      replication_factor: 1
    storage:
      type: 'filesystem'
    schemaConfig:
      configs:
      - from: 2024-01-01
        store: tsdb
        object_store: filesystem
        schema: v13
        index:
          prefix: index_
          period: 24h
    limits_config:
      retention_period: 168h # 7 days
    compactor:
      working_directory: /var/loki/compactor
      compaction_interval: 10m
      retention_enabled: true
      retention_delete_delay: 2h
      retention_delete_worker_count: 150
      delete_request_store: filesystem

  singleBinary:
    # SingleBinary supports only 1 replica without object storage (S3/GCS/Azure).
    # The upstream chart enforces this via `templates/validate.yaml`.
    replicas: 1
    persistence:
      enabled: true
      storageClass: plt-blk-hdd-repl
      size: 50Gi
    resources:
      requests:
        cpu: 100m
        memory: 256Mi
      limits:
        cpu: 500m
        memory: 512Mi
    extraInitContainers:
    - name: cleanup-corrupted-indexes
      image: busybox:latest
      command:
      - sh
      - -c
      - |
        echo "Checking for corrupted index directories..."
        # Remove any corrupted index directories (index_NNNNN pattern)
        # Common locations: tsdb-shipper-active, tsdb-shipper-cache, tsdb-index
        for dir in /var/loki/data/tsdb-shipper-active /var/loki/data/tsdb-shipper-cache /var/loki/data/tsdb-index; do
          if [ -d "$dir" ]; then
            for idx in "$dir"/index_*; do
              if [ -d "$idx" ]; then
                echo "Removing potentially corrupted index: $idx"
                rm -rf "$idx"
              fi
            done
          fi
        done
        echo "Cleanup complete"
      volumeMounts:
      - name: storage
        mountPath: /var/loki/data

  gateway:
    enabled: true
    nginxConfig:
      # Kubespray names the DNS service `coredns` (not `kube-dns`) in this cluster.
      # Also avoid hard-coding the cluster domain here; let `/etc/resolv.conf` search
      # handle it (e.g. `svc.<clusterDomain>`).
      resolver: coredns.kube-system.svc

  # Distributed mode components (unused in SingleBinary)
  backend:
    replicas: 0
  read:
    replicas: 0
  write:
    replicas: 0
