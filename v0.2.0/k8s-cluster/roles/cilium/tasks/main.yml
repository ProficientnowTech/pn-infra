- name: Set cilium state
  ansible.builtin.set_fact:
    _cilium_state: "{{ cilium_state | default('present') }}"

- name: Create values directory
  ansible.builtin.file:
    path: /tmp/cilium
    state: directory
    mode: '0755'

- name: Render Cilium values
  ansible.builtin.copy:
    src: cilium-values.yaml
    dest: /tmp/cilium/values.yaml
    mode: '0644'

- name: Ensure Cilium helm repo
  kubernetes.core.helm_repository:
    name: cilium
    repo_url: https://helm.cilium.io/
    kubeconfig: "{{ kubeconfig }}"

- name: Install/upgrade Cilium via Helm
  kubernetes.core.helm:
    name: cilium
    chart_ref: cilium/cilium
    chart_version: "{{ cilium_helm_version }}"
    release_namespace: "{{ cilium_namespace }}"
    create_namespace: true
    kubeconfig: "{{ kubeconfig }}"
    update_repo_cache: true
    values_files:
      - /tmp/cilium/values.yaml
    state: "{{ _cilium_state }}"

- name: Wait for Cilium CRDs to be available
  kubernetes.core.k8s_info:
    kubeconfig: "{{ kubeconfig }}"
    kind: CustomResourceDefinition
    name: ciliumloadbalancerippools.cilium.io
  register: cilium_crd
  until: cilium_crd.resources | length > 0
  retries: 30
  delay: 2
  when: _cilium_state == 'present'

- name: Apply Cilium L2 IP Pool
  kubernetes.core.k8s:
    state: "{{ _cilium_state }}"
    kubeconfig: "{{ kubeconfig }}"
    src: cilium/cilium-l2-ippool.yaml
  when: _cilium_state == 'present'

- name: Apply Cilium L2 Announcement
  kubernetes.core.k8s:
    state: "{{ _cilium_state }}"
    kubeconfig: "{{ kubeconfig }}"
    src: cilium/cilium-l2-announcement.yaml
  when: _cilium_state == 'present'

- name: Wait for Cilium DaemonSet to be ready
  kubernetes.core.k8s_info:
    kubeconfig: "{{ kubeconfig }}"
    kind: DaemonSet
    name: cilium
    namespace: "{{ cilium_namespace }}"
  register: cilium_ds
  until: >
    cilium_ds.resources | length > 0 and
    cilium_ds.resources[0].status.numberReady is defined and
    cilium_ds.resources[0].status.desiredNumberScheduled is defined and
    (cilium_ds.resources[0].status.numberReady | int) == (cilium_ds.resources[0].status.desiredNumberScheduled | int)
  retries: 60
  delay: 5
  when: _cilium_state == 'present'
