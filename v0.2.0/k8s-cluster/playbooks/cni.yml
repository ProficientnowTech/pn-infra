---
# Post-deploy CNI stack (Cilium + Multus + Kube-OVN) via Ansible
# Run after Kubespray completes and kubeconfig is available.

- hosts: localhost
  gather_facts: false
  vars:
    kubeconfig: "{{ lookup('env', 'KUBECONFIG') | default('~/.kube/config', true) }}"
    ansible_python_interpreter: /usr/bin/python3
    cilium_state: "{{ lookup('env','CILIUM_STATE') | default('absent', true) }}"
    multus_state: "{{ lookup('env','MULTUS_STATE') | default('absent', true) }}"
    kube_ovn_state: "{{ lookup('env','KUBE_OVN_STATE') | default('absent', true) }}"
    cilium_helm_version: "1.13.17"
    multus_version: "v4.1.4"
    kube_ovn_chart_version: "1.14.20"
  tasks:
    - name: Fail fast if kubeconfig missing
      ansible.builtin.assert:
        that:
          - kubeconfig is not none
          - kubeconfig | length > 0
        fail_msg: "KUBECONFIG not set; export KUBECONFIG to target cluster before running this playbook."

  roles:
    - role: cilium
      vars:
        cilium_namespace: "kube-system"
      when: cilium_state == 'present'
    - role: multus
      when: multus_state == 'present'
    - role: kube_ovn
      vars:
        kube_ovn_namespace: "kube-system"
      when: kube_ovn_state == 'present'
