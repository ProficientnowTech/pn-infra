# Production Environment PostgreSQL Clusters
# Internal-only cluster for platform applications
# Access via ClusterIP services only (no external LoadBalancers)
#
# Simple architecture: Direct PostgreSQL connection, no pooler
# Applications like Temporal handle their own connection pooling internally

# Kubernetes cluster DNS domain
clusterDomain: prod-ap-south-2a.local

# Global TLS Configuration
tls:
  createIssuer: true
  issuerName: platform-postgres-ca
  issuerType: selfSigned

pgClusters:
  # Internal platform database cluster
  # Contains all databases: temporal, backstage, argocd, harbor, keycloak
  - name: platform-postgres
    namespace: platform-data
    teamId: platform

    # HA with 3 replicas (Patroni handles failover)
    numberOfInstances: 3

    # Storage
    size: 350Gi
    storageClass: plt-blk-hdd-repl

    # PostgreSQL version
    pgVersion: "16"

    # No connection pooler - apps handle their own pooling
    pooler:
      enabled: false
      replica:
        enabled: false

    # Resources for PostgreSQL pods
    resources:
      requests:
        cpu: 1000m
        memory: 2Gi
      limits:
        cpu: 4000m
        memory: 8Gi

    # Application users
    users:
      temporal:
        - login
        - createdb
      backstage:
        - login
        - createdb
      argocd:
        - login
        - createdb
      harbor:
        - login
        - createdb
      keycloak:
        - login
        - createdb

    # Password rotation
    usersWithSecretRotation:
      - temporal
      - backstage
      - argocd
      - harbor
      - keycloak

    # Databases
    databases:
      temporal: temporal
      temporal_visibility: temporal
      backstage: backstage
      argocd: argocd
      harbor: harbor
      keycloak: keycloak

    # Patroni HA configuration
    patroni:
      synchronousMode: true
      synchronousModeStrict: false
      synchronousNodeCount: 1

    # Monitoring
    monitoring:
      exporterImage: quay.io/prometheuscommunity/postgres-exporter:v0.15.0
      resources:
        requests:
          cpu: 50m
          memory: 64Mi
        limits:
          cpu: 200m
          memory: 128Mi

    # PDB
    pdb:
      minAvailable: 2

    # TLS encryption (internal only - no external DNS names needed)
    tls:
      enabled: true
      duration: 2160h
      renewBefore: 720h

    # NO external access - internal ClusterIP only
    externalAccess:
      enabled: false

    # Maintenance windows
    maintenanceWindows:
      - "Sat:02:00-06:00"
      - "Sun:02:00-06:00"

    # Labels
    labels:
      environment: production
      access: internal-only

    # Pod annotations
    podAnnotations:
      backup.velero.io/backup-volumes: pgdata
      prometheus.io/scrape: "true"
      prometheus.io/port: "9187"

    # Push postgres passwords to Vault for cross-namespace secret distribution
    # Zalando creates secrets in platform-data namespace, but apps are in their own namespaces
    # PushSecret syncs to Vault, then ExternalSecret pulls to app namespaces
    pushSecretsToVault:
      enabled: true
      secretStoreRef: vault-backend
      vaultPathPrefix: platform-data/postgres
      refreshInterval: 1h
      users:
      - temporal
      - backstage
      - argocd
      - harbor
      - keycloak

    # Publish config (endpoints) to Vault
    # Apps use ExternalSecret to pull config from Vault
    # Vault path: platform-config/postgres/platform-postgres
    publishConfig:
      enabled: true
      secretStoreRef: vault-backend
      vaultPath: platform-config/postgres/platform-postgres
      refreshInterval: 1h

# ==============================================================================
# Internal Access Endpoint (created automatically by Zalando operator):
# ==============================================================================
# PostgreSQL (all operations):
#   platform-postgres.platform-data.svc:5432
#
# Patroni handles leader election and failover automatically.
# Applications connect to the service which routes to the current primary.
# ==============================================================================
