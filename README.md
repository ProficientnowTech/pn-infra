# pn-infra (v2)

GitOps infrastructure for ProficientNow, now organized around a shared API + config system. Every layer (infrastructure provisioning, image templating, Kubernetes orchestration, platform stacks, and business apps) consumes artifacts generated by the Go-based `api` module.

## Module Map

| Directory | Responsibility |
|-----------|----------------|
| `api/` | Go CLI (`./api/bin/api`) providing schema validation, config/package generation, and bootstrap helpers. Owns canonical schemas/definitions (including the legacy bootstrap assets now colocated under `api/bootstrap/`). |
| `config/` | Semantic config packages (`packages/<id>/package.json`) referenced by each module's `environments/` file. Versioning is handled via Git releases. |
| `infrastructure/` | Terraform/Packer orchestration per platform. MVP is `platforms/proxmox/terraform/{templates,pools,nodes}`, driven by `infrastructure/deploy.sh`. |
| `provisioner/` | Ansible-based image templating pipeline (static + dynamic config) invoked via the API CLI. Publishes metadata under `provisioner/outputs/`. |
| `container-orchestration/` | Kubernetes bootstrap providers (Kubespray today, Kubekey/Kind placeholders). Providers consume API outputs + config packages. |
| `platform/` | ArgoCD stack orchestrator + platform services. Depends on container-orchestration outputs and exposes APIs to business apps. |
| `business/` | App-of-apps chart plus per-app directories for business workloads (deploy via `business/charts/cluster-apps`). |
| `docs/` | Architecture notes, runbooks, platform documentation, and the `fuma-docs` site scaffold. |

## Workflow

1. **Generate artifacts**
   ```bash
   ./api/bin/api validate --target definitions
   ./api/bin/api generate env --id development --config core
   ./api/bin/api provision build --role k8s-master --env development
   ```
2. **Provision infrastructure**
   ```bash
   cd infrastructure
   ./deploy.sh --env development --phase images   # packer builds via Proxmox templates
   ./deploy.sh --env development --phase nodes    # Terraform VM deployment
   ```
3. **Bootstrap Kubernetes**
   ```bash
   cd container-orchestration/providers/kubespray
   ./deploy.sh --env development
   ```
4. **Apply platform + business stacks**
   ```bash
   cd platform
   ./run.sh --env development
   cd ../business
   helm upgrade --install cluster-apps charts/cluster-apps -f environments/development.yaml
   ```

## Repo Notes

- Legacy bootstrap scripts from `infrastructure/modules/bootstrap/` now live under `api/bootstrap/` with the same interfaces while we port the behavior into native Go commands.
- Terraform/Packer directories are being consolidated under `infrastructure/platforms/<platform>/<provider>/`. Add new providers by copying the Proxmox layout.
- Every README in the repo references this module map; use it when creating PRs that touch multiple layers.
