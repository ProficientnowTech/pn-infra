- name: Set multus state
  ansible.builtin.set_fact:
    _multus_state: "{{ multus_state | default('present') }}"

- name: Deploy Multus from upstream manifest
  kubernetes.core.k8s:
    state: "{{ _multus_state }}"
    kubeconfig: "{{ kubeconfig }}"
    src: "https://raw.githubusercontent.com/k8snetworkplumbingwg/multus-cni/{{ multus_version }}/deployments/multus-daemonset-thick.yml"

- name: Force Multus to talk to control-plane VIP
  kubernetes.core.k8s:
    state: patched
    kubeconfig: "{{ kubeconfig }}"
    api_version: apps/v1
    kind: DaemonSet
    name: kube-multus-ds
    namespace: kube-system
    merge_type:
      - strategic-merge
    definition:
      spec:
        template:
          spec:
            containers:
              - name: kube-multus
                env:
                  - name: KUBERNETES_SERVICE_HOST
                    value: "{{ multus_apiserver_host | default('192.168.100.2') }}"
                  - name: KUBERNETES_SERVICE_PORT
                    value: "{{ multus_apiserver_port | default(6443) | string }}"

- name: Ensure kube-system skips Multus defaults (Cilium-only core pods)
  kubernetes.core.k8s:
    state: patched
    kubeconfig: "{{ kubeconfig }}"
    api_version: v1
    kind: Namespace
    name: kube-system
    merge_type:
      - strategic-merge
    definition:
      metadata:
        annotations:
          k8s.v1.cni.cncf.io/default-network: ""

- name: Remove stale multus-shim before rollout
  kubernetes.core.k8s:
    state: present
    kubeconfig: "{{ kubeconfig }}"
    definition:
      apiVersion: apps/v1
      kind: DaemonSet
      metadata:
        name: multus-bin-cleanup
        namespace: kube-system
        labels:
          app: multus
          task: cleanup
      spec:
        selector:
          matchLabels:
            name: multus-bin-cleanup
        template:
          metadata:
            labels:
              name: multus-bin-cleanup
          spec:
            hostNetwork: true
            dnsPolicy: ClusterFirstWithHostNet
            containers:
              - name: cleanup
                image: docker.io/library/busybox:1.36
                securityContext:
                  privileged: true
                command:
                  - /bin/sh
                  - -c
                  - |
                    rm -f /host/opt/cni/bin/multus-shim
                    sleep 3
                volumeMounts:
                  - name: cni-bin
                    mountPath: /host/opt/cni/bin
            tolerations:
              - operator: Exists
            volumes:
              - name: cni-bin
                hostPath:
                  path: /opt/cni/bin
                  type: Directory

- name: Wait for multus cleanup to finish
  kubernetes.core.k8s_info:
    api_version: apps/v1
    kind: DaemonSet
    name: multus-bin-cleanup
    namespace: kube-system
    kubeconfig: "{{ kubeconfig }}"
  register: multus_cleanup
  until: >
    multus_cleanup.resources | length > 0
    and multus_cleanup.resources[0].status.numberReady is defined
    and multus_cleanup.resources[0].status.desiredNumberScheduled is defined
    and (multus_cleanup.resources[0].status.numberReady | int) == (multus_cleanup.resources[0].status.desiredNumberScheduled | int)
  retries: 20
  delay: 3

- name: Remove multus cleanup DaemonSet
  kubernetes.core.k8s:
    state: absent
    kubeconfig: "{{ kubeconfig }}"
    api_version: apps/v1
    kind: DaemonSet
    name: multus-bin-cleanup
    namespace: kube-system
