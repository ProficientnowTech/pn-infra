{{/*
Secret Initialization Job
CRITICAL: Only creates secrets if they DO NOT exist
Prevents accidental credential rotation that would break database connections
*/}}
---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: {{ .Release.Name }}-secret-init
  namespace: {{ .Release.Namespace }}
  labels:
    app.kubernetes.io/name: keycloak
    app.kubernetes.io/instance: {{ .Release.Name }}
    app.kubernetes.io/managed-by: {{ .Release.Service }}
  annotations:
    argocd.argoproj.io/sync-wave: "-1"
    argocd.argoproj.io/hook: PreSync
    argocd.argoproj.io/hook-delete-policy: BeforeHookCreation

---
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  name: {{ .Release.Name }}-secret-init
  namespace: {{ .Release.Namespace }}
  labels:
    app.kubernetes.io/name: keycloak
    app.kubernetes.io/instance: {{ .Release.Name }}
  annotations:
    argocd.argoproj.io/sync-wave: "-1"
    argocd.argoproj.io/hook: PreSync
    argocd.argoproj.io/hook-delete-policy: BeforeHookCreation
rules:
  - apiGroups: [""]
    resources: ["secrets"]
    verbs: ["get", "list", "create"]

---
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: {{ .Release.Name }}-secret-init
  namespace: {{ .Release.Namespace }}
  labels:
    app.kubernetes.io/name: keycloak
    app.kubernetes.io/instance: {{ .Release.Name }}
  annotations:
    argocd.argoproj.io/sync-wave: "-1"
    argocd.argoproj.io/hook: PreSync
    argocd.argoproj.io/hook-delete-policy: BeforeHookCreation
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: Role
  name: {{ .Release.Name }}-secret-init
subjects:
  - kind: ServiceAccount
    name: {{ .Release.Name }}-secret-init
    namespace: {{ .Release.Namespace }}

---
apiVersion: batch/v1
kind: Job
metadata:
  name: {{ .Release.Name }}-secret-init-{{ .Release.Revision | default "1" }}
  namespace: {{ .Release.Namespace }}
  labels:
    app.kubernetes.io/name: keycloak
    app.kubernetes.io/instance: {{ .Release.Name }}
    app.kubernetes.io/managed-by: {{ .Release.Service }}
    app.kubernetes.io/component: secret-init
  annotations:
    argocd.argoproj.io/sync-wave: "-1"
    argocd.argoproj.io/hook: PreSync
    argocd.argoproj.io/hook-delete-policy: BeforeHookCreation
spec:
  ttlSecondsAfterFinished: 300
  backoffLimit: 3
  template:
    metadata:
      labels:
        app.kubernetes.io/name: keycloak
        app.kubernetes.io/instance: {{ .Release.Name }}
        app.kubernetes.io/component: secret-init
    spec:
      serviceAccountName: {{ .Release.Name }}-secret-init
      restartPolicy: OnFailure
      containers:
        - name: secret-init
          image: bitnami/kubectl:latest
          command:
            - /bin/bash
            - -c
            - |
              set -e

              echo "=== Keycloak Secret Initialization ==="
              echo "CRITICAL: This job only creates secrets if they DO NOT exist"
              echo "Existing secrets will NEVER be modified to prevent database credential issues"
              echo ""

              # Function to generate random password
              generate_password() {
                cat /dev/urandom | tr -dc 'A-Za-z0-9!@#$%^&*()_+-=' | head -c 32
              }

              # Function to check if secret exists
              secret_exists() {
                kubectl get secret "$1" -n {{ .Release.Namespace }} &>/dev/null
              }

              # Function to create secret only if it doesn't exist
              create_secret_if_not_exists() {
                local secret_name="$1"
                shift
                local secret_data=("$@")

                if secret_exists "$secret_name"; then
                  echo "✓ Secret '$secret_name' already exists - SKIPPING (safe mode)"
                  return 0
                fi

                echo "→ Creating secret '$secret_name'..."

                # Build kubectl command
                local cmd="kubectl create secret generic $secret_name -n {{ .Release.Namespace }}"
                for data in "${secret_data[@]}"; do
                  cmd="$cmd --from-literal=$data"
                done

                eval "$cmd"
                echo "✓ Secret '$secret_name' created successfully"
              }

              echo "--- Checking/Creating Required Secrets ---"
              echo ""

              # 1. Keycloak Admin Secret
              echo "1. Keycloak Admin Credentials"
              ADMIN_PASSWORD=$(generate_password)
              create_secret_if_not_exists "keycloak-admin-secret" \
                "admin-password=$ADMIN_PASSWORD"
              echo ""

              # 2. PostgreSQL Secret
              echo "2. PostgreSQL Credentials"
              POSTGRES_ADMIN_PASSWORD=$(generate_password)
              POSTGRES_USER_PASSWORD=$(generate_password)
              create_secret_if_not_exists "keycloak-postgresql-secret" \
                "postgres-password=$POSTGRES_ADMIN_PASSWORD" \
                "password=$POSTGRES_USER_PASSWORD"
              echo ""

              # 3. GitHub OAuth Secret (optional - with placeholder)
              echo "3. GitHub OAuth Credentials"
              if secret_exists "keycloak-github-oauth"; then
                echo "✓ Secret 'keycloak-github-oauth' already exists - SKIPPING"
              else
                echo "→ Creating 'keycloak-github-oauth' with PLACEHOLDER values"
                echo "  ⚠️  UPDATE THIS SECRET with real GitHub OAuth credentials!"
                echo "  Create GitHub OAuth App at: https://github.com/settings/developers"
                echo "  Callback URL: https://{{ .Values.ingress.hostname }}/realms/proficientnow/broker/github/endpoint"

                kubectl create secret generic keycloak-github-oauth \
                  -n {{ .Release.Namespace }} \
                  --from-literal=client-id='REPLACE_WITH_GITHUB_CLIENT_ID' \
                  --from-literal=client-secret='REPLACE_WITH_GITHUB_CLIENT_SECRET'

                # Add annotation to warn users
                kubectl annotate secret keycloak-github-oauth \
                  -n {{ .Release.Namespace }} \
                  keycloak.pnats.cloud/warning='PLACEHOLDER - Update with real GitHub OAuth credentials'

                echo "✓ Placeholder secret created"
              fi
              echo ""

              echo "=== Secret Initialization Complete ==="
              echo ""
              echo "Summary:"
              kubectl get secrets -n {{ .Release.Namespace }} | grep -E "keycloak-admin-secret|keycloak-postgresql-secret|keycloak-github-oauth"
              echo ""
              echo "✓ All required secrets are present"
              echo ""
              echo "IMPORTANT NOTES:"
              echo "1. Secrets are generated ONCE and never modified automatically"
              echo "2. To rotate credentials, you must:"
              echo "   a) Delete the secret manually: kubectl delete secret <name> -n {{ .Release.Namespace }}"
              echo "   b) Update database passwords if rotating PostgreSQL secrets"
              echo "   c) Re-run this job or create secrets manually"
              echo "3. GitHub OAuth secret has PLACEHOLDER values - update with real credentials"
              echo ""
          resources:
            requests:
              cpu: 100m
              memory: 128Mi
            limits:
              cpu: 200m
              memory: 256Mi
