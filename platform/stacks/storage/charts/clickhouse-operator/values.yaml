---
# Global configuration
global:
  repoURL: 'https://github.com/ProficientnowTech/pn-infra.git'
  targetRevision: 'main'

# Labels configuration
labels:
  component: clickhouse-operator
  component-category: database
  db-type: olap
  db-type-name: clickhouse
  managed-by: argocd

# Altinity ClickHouse Operator Configuration
# Based on: https://github.com/Altinity/clickhouse-operator
altinity-clickhouse-operator:
  # Deployment strategy - Recreate is recommended for operators
  deployment:
    strategy:
      type: Recreate

  # CRD Hook - disabled for ArgoCD compatibility
  # ArgoCD handles CRDs from the chart's crds/ directory automatically
  # Helm hooks can conflict with ArgoCD's sync phases
  crdHook:
    enabled: false

  # Operator configuration
  operator:
    image:
      repository: altinity/clickhouse-operator
      tag: ""  # Uses chart appVersion (0.25.6)
      pullPolicy: IfNotPresent

    # Resource limits - balanced for HA without overkill
    resources:
      requests:
        cpu: 50m
        memory: 64Mi
      limits:
        cpu: 200m
        memory: 256Mi

    # Security context for operator container
    containerSecurityContext:
      allowPrivilegeEscalation: false
      readOnlyRootFilesystem: true
      runAsNonRoot: true
      capabilities:
        drop:
          - ALL

  # Metrics exporter configuration
  metrics:
    enabled: true
    image:
      repository: altinity/metrics-exporter
      tag: ""  # Uses chart appVersion
      pullPolicy: IfNotPresent

    # Resource limits for metrics container
    resources:
      requests:
        cpu: 25m
        memory: 32Mi
      limits:
        cpu: 100m
        memory: 128Mi

    containerSecurityContext:
      allowPrivilegeEscalation: false
      readOnlyRootFilesystem: true
      runAsNonRoot: true
      capabilities:
        drop:
          - ALL

  # Pod-level security context
  podSecurityContext:
    runAsNonRoot: true
    seccompProfile:
      type: RuntimeDefault

  # Pod labels and annotations
  podLabels:
    app.kubernetes.io/component: database-operator
    app.kubernetes.io/part-of: platform

  podAnnotations:
    prometheus.io/port: '8888'
    prometheus.io/scrape: 'true'
    clickhouse-operator-metrics/port: '9999'
    clickhouse-operator-metrics/scrape: 'true'

  # Service account and RBAC
  serviceAccount:
    create: true
    annotations: {}

  rbac:
    create: true
    # Cluster-wide scope to manage ClickHouse installations across namespaces
    namespaceScoped: false

  # Operator credentials secret
  secret:
    create: true
    username: clickhouse_operator
    # Password will be auto-generated if not set; for production, use external secrets
    password: ""

  # ServiceMonitor for Prometheus Operator
  serviceMonitor:
    enabled: true
    additionalLabels:
      release: prometheus
    clickhouseMetrics:
      interval: 30s
      scrapeTimeout: 10s
      relabelings: []
      metricRelabelings: []
    operatorMetrics:
      interval: 30s
      scrapeTimeout: 10s
      relabelings: []
      metricRelabelings: []

  # Grafana dashboards
  dashboards:
    enabled: true
    additionalLabels:
      grafana_dashboard: "1"
    annotations:
      grafana_folder: clickhouse-operator

  # HA Configuration - spread across nodes for resilience
  # Note: The operator itself is a single replica but can be scheduled
  # on any available node for quick recovery
  affinity:
    nodeAffinity:
      preferredDuringSchedulingIgnoredDuringExecution:
        - weight: 100
          preference:
            matchExpressions:
              - key: node-role.kubernetes.io/control-plane
                operator: Exists

  # Tolerate control-plane taints for scheduling flexibility
  tolerations:
    - key: node-role.kubernetes.io/control-plane
      operator: Exists
      effect: NoSchedule

  # Topology spread for HA when multiple replicas (future-proofing)
  topologySpreadConstraints: []

  # ClickHouse Operator Configuration (ConfigMap)
  # These settings control how the operator manages ClickHouse clusters
  configs:
    # Operator configuration
    01-clickhouse-operator-config.yaml: |
      # ClickHouse Operator Configuration
      # Reconciliation settings - conservative for resource efficiency
      reconcileCHIsThreadsNumber: 5
      reconcileShardsThreadsNumber: 3
      reconcileShardsMaxConcurrencyPercent: 50

      # Watch settings
      watchNamespaces:
        - "*"

      # Cluster-level settings
      chCommonConfigsPath: config.d
      chHostConfigsPath: conf.d
      chUsersConfigsPath: users.d

      # StatefulSet settings
      statefulSetUpdateStrategy: RollingUpdate
      statefulSetUpdatePollPeriod: 5

      # Pod management
      onStatefulSetCreateFailureAction: delete
      onStatefulSetUpdateFailureAction: rollback

      # Termination settings
      pod:
        terminationGracePeriod: 60

      # Logging
      logger:
        logtostderr: "true"
        alsologtostderr: "false"
        v: "1"
        stderrthreshold: ""
