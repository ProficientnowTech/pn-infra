---
# Global configuration
global:
  repoURL: 'https://github.com/ProficientnowTech/pn-infra.git'
  targetRevision: 'main'

# Labels configuration
labels:
  component: storage
  managed-by: argocd # Override default Helm with ArgoCD

# Comprehensive Rook-Ceph configuration
# Based on official v1.18.4 with enhanced CSI, monitoring, and security
rook-ceph:
  # Image configuration
  image:
    repository: rook/ceph
    tag: v1.18.4
    pullPolicy: IfNotPresent

  # Resource configuration for the operator
  resources:
    requests:
      cpu: 200m
      memory: 256Mi
    limits:
      cpu: 500m
      memory: 512Mi

  # Node selection and tolerations
  nodeSelector:
    kubernetes.io/os: linux

  tolerations:
  - key: node-role.kubernetes.io/control-plane
    operator: Equal
    effect: NoSchedule

  crds:
    enabled: true

  # CSI configuration - CSI operator is now default in v1.18+
  csi:
    disableCsiDriver: false # Enable CSI driver (default behavior)
    enableRbdDriver: true
    enableCephfsDriver: true
    enableGrpcMetrics: true
    enableCephfsSnapshotter: true
    enableRBDSnapshotter: true
    enableCSIEncryption: false

    provisionerReplicas: 2

    # Enable Ceph CSI Liveness sidecar deployment
    enableLiveness: true

    # CSI metrics configuration
    cephfsLivenessMetricsPort: 9081
    rbdLivenessMetricsPort: 8080

    serviceMonitor:
      # Disable by default: requires Prometheus Operator CRDs (ServiceMonitor).
      # Without them ArgoCD sync fails with:
      #   monitoring.coreos.com/ServiceMonitor ... Make sure the "ServiceMonitor" CRD is installed
      enabled: false

    nfs:
      enabled: false

    topology:
      enabled: false

    # CSI Log level (0-5, higher = more verbose)
    logLevel: 0

    # GRPC timeout for CSI operations
    grpcTimeoutInSeconds: 150

    # CSI RBD Plugin resources - optimized based on actual usage (~30Mi)
    # Default was 512Mi request, reduced to 64Mi
    csiRBDPluginResource: |
      - name : driver-registrar
        resource:
          requests:
            memory: 32Mi
            cpu: 25m
          limits:
            memory: 128Mi
      - name : csi-rbdplugin
        resource:
          requests:
            memory: 64Mi
            cpu: 50m
          limits:
            memory: 256Mi
      - name : liveness-prometheus
        resource:
          requests:
            memory: 32Mi
            cpu: 25m
          limits:
            memory: 128Mi

    # CSI CephFS Plugin resources - optimized based on actual usage (~22Mi)
    # Default was 512Mi request, reduced to 64Mi
    csiCephFSPluginResource: |
      - name : driver-registrar
        resource:
          requests:
            memory: 32Mi
            cpu: 25m
          limits:
            memory: 128Mi
      - name : csi-cephfsplugin
        resource:
          requests:
            memory: 64Mi
            cpu: 50m
          limits:
            memory: 256Mi
      - name : liveness-prometheus
        resource:
          requests:
            memory: 32Mi
            cpu: 25m
          limits:
            memory: 128Mi

  # Discovery daemon configuration
  enableDiscoveryDaemon: true

  # Use Host Network for Operator
  useOperatorHostNetwork: true

  # Monitoring configuration
  monitoring:
    # Disable by default: depends on Prometheus Operator CRDs (ServiceMonitor/PrometheusRule).
    enabled: false

  # Security context
  containerSecurityContext:
    runAsNonRoot: true
    runAsUser: 2016
    runAsGroup: 2016
    capabilities:
      drop: [ "ALL" ]

  # Operator settings
  currentNamespaceOnly: false

  # Log level
  logLevel: INFO
