{{- $cfg := .Values.providerSecretRefs }}
{{- if and $cfg $cfg.enabled $cfg.items }}
{{- $store := $cfg.secretStoreRef.name | default "vault-backend" }}
{{- range $item := $cfg.items }}
{{- if $item.enabled }}
apiVersion: external-secrets.io/v1
kind: ExternalSecret
metadata:
  name: {{ $item.name }}
  namespace: {{ $item.namespace | default "crossplane-system" }}
  annotations:
    argocd.argoproj.io/sync-wave: "55"
    argocd.argoproj.io/sync-options: SkipDryRunOnMissingResource=true
spec:
  refreshInterval: 1h
  secretStoreRef:
    name: {{ $store }}
    kind: ClusterSecretStore
  target:
    name: {{ $item.name }}
    creationPolicy: Owner
    deletionPolicy: Retain
  data:
  - secretKey: credentials
    remoteRef:
      key: {{ $item.vaultPath | quote }}
      {{- if $item.property }}
      property: {{ $item.property | quote }}
      {{- end }}
---
{{- end }}
{{- end }}
{{- end }}
