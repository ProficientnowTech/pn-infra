{{- $realm := .Values.realm }}
{{- if $realm.enabled }}
apiVersion: realm.keycloak.crossplane.io/v1alpha1
kind: Realm
metadata:
  name: {{ printf "%s-%s" (include "pn-keycloak.fullname" .) $realm.name | trunc 63 | trimSuffix "-" }}
  annotations:
    argocd.argoproj.io/sync-wave: "10"
    argocd.argoproj.io/sync-options: SkipDryRunOnMissingResource=true
spec:
  deletionPolicy: {{ $realm.deletionPolicy | default "Delete" }}
  providerConfigRef:
    name: {{ printf "%s-crossplane" (include "pn-keycloak.fullname" .) }}
  forProvider:
    realm: {{ $realm.name }}
    displayName: {{ $realm.displayName | quote }}
    loginWithEmailAllowed: {{ $realm.loginWithEmailAllowed }}
    registrationAllowed: {{ $realm.registrationAllowed }}
    registrationEmailAsUsername: {{ $realm.registrationEmailAsUsername }}
    duplicateEmailsAllowed: {{ $realm.duplicateEmailsAllowed }}
    resetPasswordAllowed: {{ $realm.resetPasswordAllowed }}
    editUsernameAllowed: {{ $realm.editUsernameAllowed }}
    rememberMe: {{ $realm.rememberMe }}
    verifyEmail: {{ $realm.verifyEmail }}
    sslRequired: {{ $realm.sslRequired }}
    {{- if $realm.bruteForceProtected }}
    securityDefenses:
      - bruteForceDetection:
          - failureResetTimeSeconds: {{ $realm.maxDeltaTimeSeconds }}
            maxFailureWaitSeconds: {{ $realm.maxFailureWaitSeconds }}
            maxLoginFailures: {{ $realm.failureFactor }}
            minimumQuickLoginWaitSeconds: {{ $realm.minimumQuickLoginWaitSeconds }}
            permanentLockout: {{ $realm.permanentLockout }}
            quickLoginCheckMilliSeconds: {{ $realm.quickLoginCheckMilliSeconds }}
            waitIncrementSeconds: {{ $realm.waitIncrementSeconds }}
    {{- end }}
    passwordPolicy: {{ $realm.passwordPolicy | quote }}
    accessTokenLifespan: {{ printf "%ds" (int $realm.accessTokenLifespan) | quote }}
    accessTokenLifespanForImplicitFlow: {{ printf "%ds" (int $realm.accessTokenLifespanForImplicitFlow) | quote }}
    ssoSessionIdleTimeout: {{ printf "%ds" (int $realm.ssoSessionIdleTimeout) | quote }}
    ssoSessionMaxLifespan: {{ printf "%ds" (int $realm.ssoSessionMaxLifespan) | quote }}
    offlineSessionIdleTimeout: {{ printf "%ds" (int $realm.offlineSessionIdleTimeout) | quote }}
    loginTheme: {{ $realm.loginTheme }}
    attributes:
{{- range $key, $val := $realm.attributes }}
      {{ $key }}: {{ index $val 0 | quote }}
{{- end }}
    internationalization:
      - defaultLocale: {{ $realm.defaultLocale | default "en" }}
        supportedLocales:
{{- range $realm.supportedLocales }}
          - {{ . }}
{{- end }}
{{- end }}
