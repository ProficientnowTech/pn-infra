{{- $root := . }}
{{- $realm := .Values.realm }}
{{- range $client := .Values.clients }}
apiVersion: openidclient.keycloak.crossplane.io/v1alpha1
kind: Client
metadata:
  name: {{ printf "%s-%s" (include "pn-keycloak.fullname" $root) $client.name | trunc 63 | trimSuffix "-" }}
  annotations:
    argocd.argoproj.io/sync-wave: "20"
    argocd.argoproj.io/sync-options: SkipDryRunOnMissingResource=true
spec:
  deletionPolicy: {{ $client.deletionPolicy | default "Delete" }}
  providerConfigRef:
    name: {{ printf "%s-crossplane" (include "pn-keycloak.fullname" $root) }}
  forProvider:
    realmId: {{ $realm.name }}
    clientId: {{ $client.clientId }}
    name: {{ $client.displayName | default $client.clientId | quote }}
    description: {{ $client.description | quote }}
    accessType: {{ ternary "PUBLIC" "CONFIDENTIAL" ($client.publicClient | default false) | quote }}
    standardFlowEnabled: {{ $client.standardFlowEnabled | default true }}
    implicitFlowEnabled: {{ $client.implicitFlowEnabled | default false }}
    directAccessGrantsEnabled: {{ $client.directAccessGrantsEnabled | default false }}
    serviceAccountsEnabled: {{ $client.serviceAccountsEnabled | default false }}
    rootUrl: {{ $client.rootUrl | default "" | quote }}
    baseUrl: {{ $client.baseUrl | default "" | quote }}
{{- if $client.webOrigins }}
    webOrigins:
{{- range $client.webOrigins }}
      - {{ . }}
{{- end }}
{{- end }}
{{- if $client.redirectUris }}
    validRedirectUris:
{{- range $client.redirectUris }}
      - {{ . }}
{{- end }}
{{- end }}
{{- if and (not ($client.publicClient | default false)) $client.secretRef }}
    clientSecretSecretRef:
      namespace: {{ $root.Release.Namespace }}
      name: {{ $client.secretRef.name | default (printf "pcp-%s-client-secret" $client.name) }}
      key: {{ $client.secretRef.key | default "client-secret" }}
{{- end }}
---
{{- if $client.defaultClientScopes }}
apiVersion: openidclient.keycloak.crossplane.io/v1alpha1
kind: ClientDefaultScopes
metadata:
  name: {{ printf "%s-%s-default-scopes" (include "pn-keycloak.fullname" $root) $client.name | trunc 63 | trimSuffix "-" }}
  annotations:
    argocd.argoproj.io/sync-wave: "21"
    argocd.argoproj.io/sync-options: SkipDryRunOnMissingResource=true
spec:
  providerConfigRef:
    name: {{ printf "%s-crossplane" (include "pn-keycloak.fullname" $root) }}
  forProvider:
    realmId: {{ $realm.name }}
    clientIdRef:
      name: {{ printf "%s-%s" (include "pn-keycloak.fullname" $root) $client.name | trunc 63 | trimSuffix "-" }}
    defaultScopes:
{{- range $client.defaultClientScopes }}
      - {{ . }}
{{- end }}
---
{{- end }}
{{- end }}
