---
# Temporal HA Deployment with External PostgreSQL
# Chart dependency - using upstream Temporal chart

# ==============================================================================
# Secrets Configuration (Vault-Owned via ExternalSecret)
# ==============================================================================
# Flow:
# 1. Zalando operator creates secret in platform-data namespace
# 2. PushSecret (in pg-clusters) syncs password to Vault
# 3. ExternalSecret (below) syncs from Vault to temporal namespace
#
# This gives Vault ownership for audit, rotation, and cross-namespace access
# ==============================================================================
secrets:
  postgres:
    # Sync from Vault via ExternalSecret
    # Password is pushed to Vault by PushSecret in platform-data namespace
    # Vault path: platform-data/postgres/temporal
    externalSecret:
      enabled: true
      refreshInterval: 1h
      secretStoreRef:
        name: vault-backend
        kind: ClusterSecretStore
      target:
        name: temporal-postgres-secret
        creationPolicy: Owner
      data:
      - secretKey: password
        remoteRef:
          key: platform-data/postgres/temporal
          property: password

# ==============================================================================
# Configuration (Vault-Owned via ExternalSecret)
# ==============================================================================
# Flow:
# 1. pg-clusters creates config Secret with endpoint values
# 2. PushSecret (in pg-clusters) syncs config to Vault
# 3. ExternalSecret (below) syncs from Vault to temporal namespace
#
# Simple architecture: single endpoint, Temporal handles its own connection pooling
# ==============================================================================
config:
  postgres:
    # Sync postgres endpoint from Vault via ExternalSecret
    # Config is pushed to Vault by PushSecret in platform-data namespace
    # Vault path: platform-config/postgres/platform-postgres
    externalSecret:
      enabled: true
      refreshInterval: 1h
      secretStoreRef:
        name: vault-backend
        kind: ClusterSecretStore
      target:
        name: temporal-postgres-config
        creationPolicy: Owner
      data:
      - secretKey: host
        remoteRef:
          key: platform-config/postgres/platform-postgres
          property: host
      - secretKey: port
        remoteRef:
          key: platform-config/postgres/platform-postgres
          property: port

# ==============================================================================
# Temporal Chart Configuration
# ==============================================================================
temporal:
  # Server configuration
  server:
    enabled: true
    image:
      repository: temporalio/server
      tag: "1.24.2"
      pullPolicy: IfNotPresent

    # IMMUTABLE: Do not change after initial deployment
    config:
      numHistoryShards: 512
      persistence:
        default:
          driver: "sql"
          sql:
            driver: "postgres12"
            # NOTE: Temporal chart only supports existingSecret for password.
            # Host/port must be hardcoded here. The temporal-postgres-config
            # secret (from Vault) is created for reference and future use.
            # Direct endpoint - Temporal handles its own connection pooling.
            host: "platform-postgres.platform-data.svc"
            port: 5432
            database: "temporal"
            user: "temporal"
            # Password synced from Vault via ExternalSecret
            existingSecret: "temporal-postgres-secret"
            maxConns: 20
            maxIdleConns: 20
            maxConnLifetime: "1h"
            connectAttributes:
              sslmode: require
        visibility:
          driver: "sql"
          sql:
            driver: "postgres12"
            # NOTE: Same as above - direct endpoint, password from Vault
            host: "platform-postgres.platform-data.svc"
            port: 5432
            database: "temporal_visibility"
            user: "temporal"
            # Password synced from Vault via ExternalSecret
            existingSecret: "temporal-postgres-secret"
            maxConns: 20
            maxIdleConns: 20
            maxConnLifetime: "1h"
            connectAttributes:
              sslmode: require
      namespaces:
        create: true
        namespace:
        - name: "default"
          retention: "72h" # 3 days in hours
        - name: "pnats"
          retention: "2160h" # 90 days in hours
        - name: "pnats-staging"
          retention: "1440h" # 60 days in hours
        - name: "pnats-dev"
          retention: "720h" # 30 days in hours
      logLevel: "info,warn"
    replicaCount: 3 # This is for the server container, individual services have their own replicas
    # Service configuration
    frontend:
      service:
        type: ClusterIP
        port: 7233
      ingress:
        enabled: true
        className: "nginx"
        annotations:
          cert-manager.io/cluster-issuer: letsencrypt-production
          external-dns.alpha.kubernetes.io/hostname: temporal-sdk.pnats.cloud
          external-dns.alpha.kubernetes.io/ttl: "60"
          nginx.ingress.kubernetes.io/backend-protocol: "GRPC"
          nginx.ingress.kubernetes.io/ssl-redirect: "true"
        hosts:
        - temporal-sdk.pnats.cloud
        tls:
        - secretName: temporal-sdk-tls
          hosts:
          - temporal-sdk.pnats.cloud
    # Resource allocation per pod
    resources:
      requests:
        cpu: 200m
        memory: 512Mi
      limits:
        cpu: 2000m
        memory: 2Gi
    # Metrics configuration
    metrics:
      annotations:
        enabled: true
      serviceMonitor:
        enabled: true
        interval: 30s
      prometheus:
        timerType: histogram
  # Individual service replicas for HA
  frontend:
    replicaCount: 3
    metrics:
      serviceMonitor:
        enabled: true
        interval: 30s
    resources:
      requests:
        cpu: 200m
        memory: 512Mi
      limits:
        cpu: 1000m
        memory: 1Gi
  history:
    replicaCount: 3
    metrics:
      serviceMonitor:
        enabled: true
        interval: 30s
    resources:
      requests:
        cpu: 500m
        memory: 1Gi
      limits:
        cpu: 2000m
        memory: 4Gi
  matching:
    replicaCount: 3
    metrics:
      serviceMonitor:
        enabled: true
        interval: 30s
    resources:
      requests:
        cpu: 200m
        memory: 512Mi
      limits:
        cpu: 1000m
        memory: 1Gi
  worker:
    replicaCount: 5
    resources:
      requests:
        cpu: 200m
        memory: 512Mi
      limits:
        cpu: 1000m
        memory: 1Gi
  # Web UI
  web:
    enabled: true
    replicaCount: 2
    image:
      repository: temporalio/ui
      tag: "2.26.2"
      pullPolicy: IfNotPresent
    service:
      type: ClusterIP
      port: 8080
      annotations: {}
    ingress:
      enabled: true
      className: "nginx"
      annotations:
        cert-manager.io/cluster-issuer: letsencrypt-production
        external-dns.alpha.kubernetes.io/hostname: temporal.pnats.cloud
        external-dns.alpha.kubernetes.io/ttl: "60"
      hosts:
      - "temporal.pnats.cloud"
      tls:
      - secretName: temporal-ui-tls
        hosts:
        - temporal.pnats.cloud
    resources:
      requests:
        cpu: 100m
        memory: 128Mi
      limits:
        cpu: 500m
        memory: 512Mi
    # Web UI configuration to connect to Temporal cluster
    additionalEnv:
    - name: TEMPORAL_CORS_ORIGINS
      value: "https://temporal.pnats.cloud"
  # Admin tools
  admintools:
    enabled: true
    image:
      repository: temporalio/admin-tools
      tag: "1.24.2-tctl-1.18.1-cli-1.0.0"
      pullPolicy: IfNotPresent
    service:
      type: ClusterIP
      port: 22
  # Schema setup and updates
  schema:
    setup:
      enabled: true
      backoffLimit: 100
    update:
      enabled: true
      backoffLimit: 100
  # PostgreSQL - Using external Zalando postgres-operator cluster
  postgresql:
    enabled: false
  # Disable Cassandra (using PostgreSQL)
  cassandra:
    enabled: false
  # Disable MySQL
  mysql:
    enabled: false
  # Disable Elasticsearch (using PostgreSQL for visibility)
  elasticsearch:
    enabled: false
  # Use cluster Prometheus
  prometheus:
    enabled: false
  # Grafana dashboards only (using cluster Grafana instance)
  grafana:
    enabled: true
    replicas: 0 # Don't deploy Grafana pods, just create dashboard ConfigMaps
    testFramework:
      enabled: false
    rbac:
      create: false
      pspEnabled: false
      namespaced: true
    dashboardProviders:
      dashboardproviders.yaml:
        apiVersion: 1
        providers:
        - name: "temporal"
          orgId: 1
          folder: "Temporal"
          type: file
          disableDeletion: true
          editable: true
          options:
            path: /var/lib/grafana/dashboards/temporal
    datasources:
      datasources.yaml:
        apiVersion: 1
        datasources:
        - name: TemporalMetrics
          type: prometheus
          url: http://prometheus-kube-prometheus-prometheus.monitoring.svc:9090
          access: proxy
          isDefault: false
    dashboards:
      default:
        server-general-github:
          url: https://raw.githubusercontent.com/temporalio/dashboards/helm/server/server-general.json
          datasource: TemporalMetrics
        sdk-general-github:
          url: https://raw.githubusercontent.com/temporalio/dashboards/helm/sdk/sdk-general.json
          datasource: TemporalMetrics
        misc-advanced-visibility-specific-github:
          url: https://raw.githubusercontent.com/temporalio/dashboards/helm/misc/advanced-visibility-specific.json
          datasource: TemporalMetrics
        misc-clustermonitoring-kubernetes-github:
          url: https://raw.githubusercontent.com/temporalio/dashboards/helm/misc/clustermonitoring-kubernetes.json
          datasource: TemporalMetrics
        misc-frontend-service-specific-github:
          url: https://raw.githubusercontent.com/temporalio/dashboards/helm/misc/frontend-service-specific.json
          datasource: TemporalMetrics
        misc-history-service-specific-github:
          url: https://raw.githubusercontent.com/temporalio/dashboards/helm/misc/history-service-specific.json
          datasource: TemporalMetrics
        misc-matching-service-specific-github:
          url: https://raw.githubusercontent.com/temporalio/dashboards/helm/misc/matching-service-specific.json
          datasource: TemporalMetrics
        misc-worker-service-specific-github:
          url: https://raw.githubusercontent.com/temporalio/dashboards/helm/misc/worker-service-specific.json
          datasource: TemporalMetrics
