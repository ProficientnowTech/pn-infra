---
# OneUptime Core Secrets - oneuptimeSecret and encryptionSecret
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: oneuptime-core-secrets
  namespace: {{ .Release.Namespace }}
  annotations:
    argocd.argoproj.io/sync-wave: "4"
  labels:
    app.kubernetes.io/name: oneuptime
    app.kubernetes.io/component: core
spec:
  refreshInterval: 1h
  secretStoreRef:
    name: vault-backend
    kind: ClusterSecretStore
  target:
    name: oneuptime-core-secrets
    creationPolicy: Merge
  data:
  - secretKey: oneuptimeSecret
    remoteRef:
      key: applications/monitoring/oneuptime/core
      property: oneuptimeSecret
  - secretKey: encryptionSecret
    remoteRef:
      key: applications/monitoring/oneuptime/core
      property: encryptionSecret
---
# Keycloak OIDC Client Credentials
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: oneuptime-oidc-client-secret
  namespace: {{ .Release.Namespace }}
  annotations:
    argocd.argoproj.io/sync-wave: "4"
  labels:
    app.kubernetes.io/name: oneuptime
    app.kubernetes.io/component: auth
spec:
  refreshInterval: 1h
  secretStoreRef:
    name: vault-backend
    kind: ClusterSecretStore
  target:
    name: oneuptime-oidc-client-secret
    creationPolicy: Merge
    template:
      engineVersion: v2
      data:
        client-id: "{{ `{{ .clientId }}` }}"
        client-secret: "{{ `{{ .clientSecret }}` }}"
        issuer-url: "https://keycloak.pnats.cloud/realms/pcp"
        auth-url: "https://keycloak.pnats.cloud/realms/pcp/protocol/openid-connect/auth"
        token-url: "https://keycloak.pnats.cloud/realms/pcp/protocol/openid-connect/token"
        userinfo-url: "https://keycloak.pnats.cloud/realms/pcp/protocol/openid-connect/userinfo"
        jwks-url: "https://keycloak.pnats.cloud/realms/pcp/protocol/openid-connect/certs"
  data:
  - secretKey: clientId
    remoteRef:
      key: applications/security/keycloak/clients/oneuptime
      property: client-id
  - secretKey: clientSecret
    remoteRef:
      key: applications/security/keycloak/clients/oneuptime
      property: client-secret

---
# SMTP Email Configuration Secret
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: oneuptime-smtp-secret
  namespace: {{ .Release.Namespace }}
  annotations:
    argocd.argoproj.io/sync-wave: "4"
  labels:
    app.kubernetes.io/name: oneuptime
    app.kubernetes.io/component: notifications
spec:
  refreshInterval: 1h
  secretStoreRef:
    name: vault-backend
    kind: ClusterSecretStore
  target:
    name: oneuptime-smtp-secret
    creationPolicy: Merge
  data:
  - secretKey: smtp-host
    remoteRef:
      key: applications/monitoring/oneuptime/smtp
      property: host
  - secretKey: smtp-port
    remoteRef:
      key: applications/monitoring/oneuptime/smtp
      property: port
  - secretKey: smtp-user
    remoteRef:
      key: applications/monitoring/oneuptime/smtp
      property: user
  - secretKey: smtp-password
    remoteRef:
      key: applications/monitoring/oneuptime/smtp
      property: password
  - secretKey: smtp-from
    remoteRef:
      key: applications/monitoring/oneuptime/smtp
      property: from
  - secretKey: smtp-from-name
    remoteRef:
      key: applications/monitoring/oneuptime/smtp
      property: from-name

---
# Slack Notification Webhooks Secret
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: oneuptime-slack-webhooks
  namespace: {{ .Release.Namespace }}
  annotations:
    argocd.argoproj.io/sync-wave: "4"
  labels:
    app.kubernetes.io/name: oneuptime
    app.kubernetes.io/component: notifications
spec:
  refreshInterval: 1h
  secretStoreRef:
    name: vault-backend
    kind: ClusterSecretStore
  target:
    name: oneuptime-slack-webhooks
    creationPolicy: Merge
  data:
  - secretKey: on-create-user
    remoteRef:
      key: applications/monitoring/oneuptime/slack
      property: webhook-on-create-user
  - secretKey: on-delete-project
    remoteRef:
      key: applications/monitoring/oneuptime/slack
      property: webhook-on-delete-project
  - secretKey: on-create-project
    remoteRef:
      key: applications/monitoring/oneuptime/slack
      property: webhook-on-create-project
  - secretKey: on-subscription-update
    remoteRef:
      key: applications/monitoring/oneuptime/slack
      property: webhook-on-subscription-update

---
# Slack App OAuth Credentials Secret
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: oneuptime-slack-app-secret
  namespace: {{ .Release.Namespace }}
  annotations:
    argocd.argoproj.io/sync-wave: "4"
  labels:
    app.kubernetes.io/name: oneuptime
    app.kubernetes.io/component: slack-app
spec:
  refreshInterval: 1h
  secretStoreRef:
    name: vault-backend
    kind: ClusterSecretStore
  target:
    name: oneuptime-slack-app-secret
    creationPolicy: Merge
  data:
  - secretKey: client-id
    remoteRef:
      key: applications/monitoring/oneuptime/slack-app
      property: client-id
  - secretKey: client-secret
    remoteRef:
      key: applications/monitoring/oneuptime/slack-app
      property: client-secret
  - secretKey: signing-secret
    remoteRef:
      key: applications/monitoring/oneuptime/slack-app
      property: signing-secret
