# values.yaml - Harbor Production Configuration with ExternalSecrets (Vault)
# Values must be nested under 'harbor:' key since harbor is a dependency chart

# ==============================================================================
# Secrets Configuration (Vault-Owned via ExternalSecret)
# ==============================================================================
# Prerequisites: Create secrets in Vault before deploying Harbor
# See: docs/platform/vault-secret-prerequisites.md
#
# Vault paths:
#   - applications/developer-platform/harbor/core
#   - applications/developer-platform/harbor/s3
# ==============================================================================
secrets:
  core:
    externalSecret:
      enabled: true
      refreshInterval: 1h
      secretStoreRef:
        name: vault-backend
        kind: ClusterSecretStore
      target:
        name: harbor-core-secrets
        creationPolicy: Owner
      data:
      - secretKey: REGISTRY_HTPASSWD
        remoteRef:
          key: applications/developer-platform/harbor/core
          property: REGISTRY_HTPASSWD
      - secretKey: REGISTRY_PASSWD
        remoteRef:
          key: applications/developer-platform/harbor/core
          property: REGISTRY_PASSWD
      - secretKey: admin-password
        remoteRef:
          key: applications/developer-platform/harbor/core
          property: admin-password
      - secretKey: database-password
        remoteRef:
          key: applications/developer-platform/harbor/core
          property: database-password
      - secretKey: jobservice-secret
        remoteRef:
          key: applications/developer-platform/harbor/core
          property: jobservice-secret
      - secretKey: registry-http-secret
        remoteRef:
          key: applications/developer-platform/harbor/core
          property: registry-http-secret
      - secretKey: secret
        remoteRef:
          key: applications/developer-platform/harbor/core
          property: secret
      - secretKey: secretKey
        remoteRef:
          key: applications/developer-platform/harbor/core
          property: secretKey

  s3:
    externalSecret:
      enabled: true
      refreshInterval: 1h
      secretStoreRef:
        name: vault-backend
        kind: ClusterSecretStore
      target:
        name: harbor-s3-credentials
        creationPolicy: Owner
      data:
      - secretKey: REGISTRY_STORAGE_S3_ACCESSKEY
        remoteRef:
          key: applications/developer-platform/harbor/s3
          property: REGISTRY_STORAGE_S3_ACCESSKEY
      - secretKey: REGISTRY_STORAGE_S3_SECRETKEY
        remoteRef:
          key: applications/developer-platform/harbor/s3
          property: REGISTRY_STORAGE_S3_SECRETKEY

# ==============================================================================
# Harbor Chart Configuration
# ==============================================================================
harbor:
  expose:
    type: ingress
    tls:
      enabled: true
      certSource: secret
      secret:
        secretName: "harbor-tls"
    ingress:
      hosts:
        core: registry.pnats.cloud
      controller: ingress-nginx
      className: "nginx"
      annotations:
        ingress.kubernetes.io/ssl-redirect: "true"
        ingress.kubernetes.io/proxy-body-size: "0"
        nginx.ingress.kubernetes.io/ssl-redirect: "true"
        nginx.ingress.kubernetes.io/proxy-body-size: "0"
        # Cert-Manager for TLS certificates
        cert-manager.io/cluster-issuer: "letsencrypt-production"
        # ExternalDNS for DNS management - will create records for registry.pnats.cloud
        external-dns.alpha.kubernetes.io/hostname: "registry.pnats.cloud"

  externalURL: https://registry.pnats.cloud

  # CA Secret - use the same TLS secret for CA (Let's Encrypt CA is in the chain)
  caSecretName: "harbor-tls"

  persistence:
    enabled: true
    resourcePolicy: "keep"
    persistentVolumeClaim:
      jobservice:
        jobLog:
          storageClass: "app-blk-hdd-repl"
          accessMode: ReadWriteOnce
          size: 1Gi
      database:
        storageClass: "app-blk-hdd-repl"
        accessMode: ReadWriteOnce
        size: 1Gi
      redis:
        storageClass: "app-blk-hdd-repl"
        accessMode: ReadWriteOnce
        size: 1Gi
      trivy:
        storageClass: "app-blk-hdd-repl"
        accessMode: ReadWriteOnce
        size: 5Gi
    imageChartStorage:
      type: s3
      disableredirect: false
      s3:
        region: ap-south-2
        bucket: harbor
        regionendpoint: https://s3.pnats.cloud
        encrypt: false
        secure: true
        # Reference to ExternalSecret for S3 credentials (from Vault)
        existingSecret: "harbor-s3-credentials"
        existingSecretAccessKey: "REGISTRY_STORAGE_S3_ACCESSKEY"
        existingSecretSecretKey: "REGISTRY_STORAGE_S3_SECRETKEY"
        v4auth: true
        forcepathstyle: true

  # Admin password from ExternalSecret (Vault)
  existingSecretAdminPassword: "harbor-core-secrets"
  existingSecretAdminPasswordKey: "admin-password"

  # Disable IPv6
  ipFamily:
    ipv6:
      enabled: false
    ipv4:
      enabled: true

  # Security configuration
  internalTLS:
    enabled: false

  # General settings
  imagePullPolicy: IfNotPresent

  # Encryption key from ExternalSecret (Vault)
  existingSecretSecretKey: "harbor-core-secrets"
  existingSecretSecretKeyKey: "secretKey"

  # Component configurations
  portal:
    image:
      repository: docker.io/goharbor/harbor-portal
      tag: v2.14.1
    replicas: 2

  core:
    image:
      repository: docker.io/goharbor/harbor-core
      tag: v2.14.1
    replicas: 2
    # Registry password from ExternalSecret (Vault)
    existingSecret: "harbor-core-secrets"
    existingSecretKey: "secret"
    extraEnvVars:
    - name: TOKEN_SERVICE_URL
      value: https://registry.pnats.cloud/service/token

  jobservice:
    image:
      repository: docker.io/goharbor/harbor-jobservice
      tag: v2.14.1
    replicas: 1
    # Jobservice secret from ExternalSecret (Vault)
    existingSecret: "harbor-core-secrets"
    existingSecretKey: "jobservice-secret"

  registry:
    registry:
      image:
        repository: docker.io/goharbor/registry-photon
        tag: v2.14.1
    controller:
      image:
        repository: docker.io/goharbor/harbor-registryctl
        tag: v2.14.1
    replicas: 1
    # Registry HTTP secret from ExternalSecret (Vault)
    existingSecret: "harbor-core-secrets"
    existingSecretKey: "registry-http-secret"
    credentials:
      username: "admin"
      password: "Harbor12345"
      htpasswdString: "admin:$2y$05$QuYqMD3DYgN0YDiaj15.A.SmR0C5w2MmLOE76hKLCAIPPX2Ep6Z6i"

  database:
    type: internal
    internal:
      image:
        repository: docker.io/goharbor/harbor-db
        tag: v2.14.1
      # Database password from ExternalSecret (Vault)
      existingSecret: "harbor-core-secrets"
      existingSecretPasswordKey: "database-password"
